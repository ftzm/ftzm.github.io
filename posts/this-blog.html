<!DOCTYPE html>
<html lang="en">
  <head profile="http://www.w3.org/2005/10/profile">
      <meta charset="UTF-8">
      <meta name="description" content="">
      <meta name="author" content="">
      <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="New Year, New Blog">
      <meta name="twitter:description" content="">
          <title>New Year, New Blog</title>
      <link rel="stylesheet" href="/css/tufte.css">
      <link rel="stylesheet" href="/css/custom.css">
      <link rel="stylesheet" href="/css/syntax-minimal.css">
  </head>
<body>
    <!--<header>
    <nav class="smallHide">
        <a  href="/">
            <div id="home-text"> Home </div>
        </a>
        <a  href="/">
            <div id="home-text"> Blog </div>
        </a>
        <a  href="/about">
            <div id="home-text"> About </div>
        </a>
    </nav>
    <div id="menu" class="bigHide"><i class="fas fa-bars"></i></div>

    <div class="right-sidebar">
        <a class="ext-link smallHide" href="/atom.xml">
	  <i class="fas fa-rss"></i>
        </a>

	<div id="theme-button" class="smallHide">
	  <i class="fas fa-adjust"></i>
	</div>
    </div>
</header>
->

<div id="page">
    <div class="wrapper">
        <div class="masthead">
            <div class="tags">
	      <span class="doctype">Article</span>
              —
              <a href="/tag/slick" class="tag slick">slick</a>

              <a href="/tag/haskell" class="tag haskell">haskell</a>

              <a href="/tag/pandoc" class="tag pandoc">pandoc</a>

              <a href="/tag/nix" class="tag nix">nix</a>
            </div>
            <br>

            <br>
            <div class="metadata">
            <span class="author">Matthew Fitzsimmons</span>
            <span class="published">04 Jan 2021 • 15 min read</span>
            </div>
	    <hr>
        </div>
    </div>-->

  
      <section class="masthead">
        <span class="logo2"><a class="no-tufte-underline" href="/">ftzm</a></span>
        <span class="link"><a class="no-tufte-underline" href="/">home</a></span>
        <span class="link"><a class="no-tufte-underline" href="/">blog</a></span>
        <span class="link"><a class="no-tufte-underline" href="/about">about</a></span>
      </section>
    <section>
    <h1> New Year, New Blog </h1>
    <p>I've overhauled my
blog<span><label for="sn-f4f61b01-0283-4c25-8c62-4d120ffb83ba" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-f4f61b01-0283-4c25-8c62-4d120ffb83ba" class="margin-toggle"/><span
class="sidenote">Did this involve writing any substantive new content?
Of course not! Fiddling with styling and deployment systems is the most
import part of creating a blog.</span></span>. It's still static, and
I'm still using Haskell and Nix, but nearly everything else has changed.
I have:</p>
<ul>
<li>given it a new style with a dark mode</li>
<li>switched the blog framework from Hakyll to Slick</li>
<li>migrated the nix bootstrapping to flakes</li>
<li>switched from a docker image to a NixOS server deployed via
deploy-rs</li>
</ul>
<p>It was a
totally<span><label for="sn-bce2f31e-4c09-45de-94ca-d04d626488c4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-bce2f31e-4c09-45de-94ca-d04d626488c4" class="margin-toggle"/><span
class="sidenote">Fun isn’t necessary, but that doesn’t mean it’s not
worthwhile.</span></span> unnecessary project, but it gave me a welcome
chance to play around with some new tools over the holidays, and I'm
very happy with how it turned out. The following is a write-up of the
major features of the new implementation.</p>
<section id="written-in-org-mode" class="level2">
<h2>Written in org mode</h2>
<p>Markdown might be the more obvious choice as a markup language, but
if you've already invested in becoming productive with org mode then the
latter is easily the better option. It's also best to reduce friction to
creating content, and org mode is what I naturally reach for when I want
to capture and expand on an idea.</p>
</section>
<section id="generated-with-haskell-slick" class="level2">
<h2>Generated with Haskell + Slick</h2>
<p>Hakyll has served me well for years, but so far I'm happy with the
switch to the simpler Slick. Hakyll's "DSL" makes it easy to get
up-and-running if you follow established patterns, but it's implemented
in a sufficiently mystical fashion to make changing or adding
functionality a real headache. Slick, on the other hand, is much easier
to grok; it essentially consists of some utilities to glue together
well-established libraries and tools:</p>
<ul>
<li>Pandoc to convert between the markup language and HTML</li>
<li>Mustache for templating</li>
<li>Shake for building and caching the output files</li>
<li>Aeson to manipulate JSON at various stages</li>
</ul>
<p>A slick blog requires a few more lines and bit more up-front
understanding on the part of the author, but in my view it is easier and
more transparent in the long run.</p>
<section id="using-org-mode-with-slick" class="level3">
<h3>Using Org-mode with Slick</h3>
<p>As of now Slick only has built-in support for markdown. Thankfully
it's trivial to switch out the default markdown parsing functions with
custom code to handle org mode. The <code>orgToHTML</code> function
below can be used in place of slick's <code>markdownToHTML</code>:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Aeson</span> <span class="kw">as</span> <span class="dt">A</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Development.Shake</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Pandoc</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Slick.Pandoc</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ot">defaultOrgOptions ::</span> <span class="dt">ReaderOptions</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>defaultOrgOptions <span class="ot">=</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  def { readerExtensions <span class="ot">=</span> exts }</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    exts <span class="ot">=</span> <span class="fu">mconcat</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>     [ extensionsFromList</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>       [ <span class="dt">Ext_fenced_code_attributes</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>       , <span class="dt">Ext_auto_identifiers</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>       ]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>     ]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ot">orgToHTMLWithOpts ::</span> <span class="dt">ReaderOptions</span> <span class="ot">-&gt;</span> <span class="dt">WriterOptions</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">Action</span> <span class="dt">Value</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>orgToHTMLWithOpts rops wops txt <span class="ot">=</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  loadUsing (readOrg rops) (writeHtml5String wops) txt</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="ot">orgToHTML ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">Action</span> <span class="dt">Value</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>orgToHTML txt <span class="ot">=</span>  orgToHTMLWithOpts defaultOrgOptions defaultHtml5Options txt</span></code></pre></div>
</section>
<section id="handling-arbitrary-org-metadata-with-pandoc"
class="level3">
<h3>Handling arbitrary org metadata with Pandoc</h3>
<p>The downside of using org mode is the limited support for metadata
parsing. Unlike the markdown parser, the org mode parser doesn't support
yaml style metadata like the following:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span><span class="kw">:</span><span class="at"> my article</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tags</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">writing</span><span class="kw">,</span><span class="at"> blogging</span><span class="kw">]</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span></code></pre></div>
<p>It does support the standard org mode metadata format, where lines of
the format <code>#+key: value</code> are placed at the beginning of the
file. However, only a few standard keys are recognized–the rest are
ignored. Thankfully the <code>Pandoc</code> datatype can be easily be
re-parsed to capture un-parsed metadata lines. See below:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Aeson</span> <span class="kw">as</span> <span class="dt">A</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Char</span> (toLower)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">L</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Development.Shake</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Slick.Pandoc</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Pandoc</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Pandoc.Builder</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Pandoc.Parsing</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Parse a RawBlock as an org metadata key-value pair.</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="ot">orgMetaKV ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> (<span class="dt">T.Text</span>, <span class="dt">MetaValue</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>orgMetaKV (<span class="dt">RawBlock</span> _ txt) <span class="ot">=</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> (parse parser <span class="st">&quot;&quot;</span> txt) <span class="kw">of</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> err  <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="fu">show</span> err</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> xs  <span class="ot">-&gt;</span> xs</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    parser <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>      _ <span class="ot">&lt;-</span> string <span class="st">&quot;#+&quot;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      key <span class="ot">&lt;-</span> manyTill anyChar <span class="op">$</span> string <span class="st">&quot;: &quot;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> colonList <span class="op">&lt;|&gt;</span> remainder</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span> (T.pack <span class="op">$</span> L.map <span class="fu">toLower</span> key, toMetaValue value)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    colonList <span class="ot">=</span> toMetaValue <span class="op">&lt;$&gt;</span> <span class="kw">do</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      _ <span class="ot">&lt;-</span> char <span class="ch">&#39;:&#39;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      endBy (many alphaNum) (char <span class="ch">&#39;:&#39;</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    remainder <span class="ot">=</span> toMetaValue <span class="op">&lt;$&gt;</span> many anyChar</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>orgMetaKV _ <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Invalid block type for org metadata&quot;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Parse unparsed org metadata from pandoc blocks and move to Meta.</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- This is useful because Pandoc&#39;s org parser ignores all but a few</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- metadata keys by default.</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="ot">orgAllMeta ::</span> <span class="dt">Pandoc</span> <span class="ot">-&gt;</span> <span class="dt">Pandoc</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>orgAllMeta (<span class="dt">Pandoc</span> (<span class="dt">Meta</span> meta) blocks) <span class="ot">=</span> <span class="dt">Pandoc</span> expandedMeta remainderBlocks</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    expandedMeta <span class="ot">=</span> <span class="dt">Meta</span> <span class="op">$</span> M.union meta newMeta</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    newMeta <span class="ot">=</span> M.fromList <span class="op">$</span> L.map orgMetaKV rawMeta</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    (rawMeta, remainderBlocks) <span class="ot">=</span> <span class="fu">span</span> rawOrgBlock blocks</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    rawOrgBlock b</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>      <span class="op">|</span> <span class="dt">RawBlock</span> (<span class="dt">Format</span> <span class="st">&quot;org&quot;</span>) _ <span class="ot">&lt;-</span> b <span class="ot">=</span> <span class="dt">True</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>      <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dt">False</span></span></code></pre></div>
<p>We can plug this into the previous code by making the following
change:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">orgToHTMLWithOpts ::</span> <span class="dt">ReaderOptions</span> <span class="ot">-&gt;</span> <span class="dt">WriterOptions</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">Action</span> <span class="dt">Value</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>orgToHTMLWithOpts rops wops txt <span class="ot">=</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  loadUsing</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">fmap</span> orgAllMeta <span class="op">&lt;$&gt;</span> readOrg rops) <span class="co">-- &lt;$&gt; is over partially applied func</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    (writeHtml5String wops)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    txt</span></code></pre></div>
</section>
</section>
<section id="built-with-nix" class="level2">
<h2>Built with Nix</h2>
<p>The project derivations are defined in a
<code>release.nix</code>:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">}</span>:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">rec</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">generator</span> <span class="op">=</span> pkgs.haskellPackages.developPackage <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">root</span> <span class="op">=</span> <span class="ss">./.</span><span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">modifier</span> <span class="op">=</span> <span class="va">drv</span><span class="op">:</span> pkgs.haskell.lib.overrideCabal drv <span class="op">(</span><span class="va">attrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">buildTools</span> <span class="op">=</span> <span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">(</span>attrs.buildTools <span class="kw">or</span> <span class="op">[])</span> <span class="op">++</span> <span class="op">[</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>          haskellPackages.cabal-install</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>          haskellPackages.hpack</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>          haskellPackages.ghcid</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>          zlib</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">];</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">configureFlags</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;--extra-lib-dirs=</span><span class="sc">${</span>pkgs.zlib<span class="sc">}</span><span class="st">/lib&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">];</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">})</span> <span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">files</span> <span class="op">=</span> pkgs.stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;ftzm-blog&quot;</span><span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">src</span> <span class="op">=</span> <span class="ss">./.</span><span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="va">phases</span> <span class="op">=</span> <span class="st">&quot;unpackPhase buildPhase&quot;</span><span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;0.1&quot;</span><span class="op">;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span> generator <span class="op">];</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="va">buildPhase</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="st">      mkdir $out</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="st">      export LOCALE_ARCHIVE=&quot;</span><span class="sc">${</span>pkgs.glibcLocales<span class="sc">}</span><span class="st">/lib/locale/locale-archive&quot;;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="st">      export LANG=en_US.UTF-8</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="st">      build-site</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="st">      cp -r docs/* $out</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;</span><span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a> <span class="op">};</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The first derivation is a simple haskell build of the blog generator.
It relies on a standard <code>project.yaml</code> in the root directory
which defines the details of the haskell build. Defining the haskell
build in a project.yaml rather than in nix itself allows us to use cabal
in a nix shell for local development, which is considerably more
convenient. The second derivation simply uses the binary from the first
derivation to build the site's static assets.</p>
<p>I don't build the derivation in this file directly; I call it from a
<a href="https://nixos.wiki/wiki/Flakes">flake file</a> like the
following:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> <span class="st">&quot;blog&quot;</span><span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span>.<span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/19b5ddfbb951013461d39352bf05e6248369d580&quot;</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span> <span class="op">}</span>:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">packages</span> <span class="op">=</span> <span class="kw">with</span> <span class="bu">import</span> nixpkgs <span class="op">{</span> <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>          callPackage <span class="ss">./release.nix</span> <span class="op">{};</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">packages</span>.<span class="va">x86_64-linux</span>.<span class="va">generator</span> <span class="op">=</span> packages.generator<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">packages</span>.<span class="va">x86_64-linux</span>.<span class="va">files</span> <span class="op">=</span> packages.files<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">defaultPackage</span>.<span class="va">x86_64-linux</span> <span class="op">=</span> packages.generator<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>While still experimental, I've found flakes to be very ergonomic, and
I really appreciate the first-class support for dependency pinning.
Using this flake, I can build the (default package) generator with
<code>nix build</code> or target the files attribute with
<code>nix build .#files</code>.</p>
</section>
<section id="local-development" class="level2">
<h2>Local development</h2>
<p>Using flakes, we can run <code>nix develop</code> to start a
development shell for the default package of the flake (in this case the
generator). This will make cabal available and other build tools
available. We can serve up the statically generated files via <a
href="https://www.npmjs.com/package/serve">serve</a>, and use <a
href="https://eradman.com/entrproject/">entr</a> to ensure that the
files are re-generated on changes to the generator. Here's the script
I'm using for this site:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env bash</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild on template/content change</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> site/ <span class="kw">|</span> <span class="ex">entr</span> <span class="at">-p</span> sh <span class="at">-c</span> <span class="st">&#39;cabal run&#39;</span> <span class="kw">&amp;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild on generator change</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> app/ <span class="kw">|</span> <span class="ex">entr</span> <span class="at">-p</span> sh <span class="at">-c</span> <span class="st">&#39;rm -r .shake; rm -r docs; cabal run&#39;</span> <span class="kw">&amp;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up the terminal on exit</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="bu">trap</span> <span class="st">&quot;reset&quot;</span> EXIT</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Serve static files</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="ex">serve</span> docs</span></code></pre></div>
</section>
<section id="deployed-with-deploy-rs" class="level2">
<h2>Deployed with deploy-rs</h2>
<p>The blog files are served by Nginx on a tiny server running NixOS. To
deploy I'm using <a
href="https://github.com/serokell/deploy-rs">deploy-rs</a>, a new nix
deployment tool by the folks at <a
href="https://www.serokell.io">Serokell</a>. So far I prefer it to other
nix deployment tools I've used in the past, mainly because:</p>
<ul>
<li>It's stateless</li>
<li>It's based on flakes, making version pinning first class.</li>
<li>It's well-documented and easy to use (not a given for tools in this
space)</li>
</ul>
<p>Like other tools of this nature, it relies on a NixOS configuration
for the server and some extra configuration governing building and
deployment details. The my full <code>server.nix</code> contains many
incidental details beyond the scope of this article, but the key portion
defining the nginx service serving the blog is as follows:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>services = <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">nginx</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">virtualHosts</span>.<span class="st">&quot;ftzm.org&quot;</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">enableACME</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">forceSSL</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">root</span> <span class="op">=</span> <span class="st">&quot;</span><span class="sc">${</span>nginxWebRoot<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">locations</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span>/<span class="st">&quot;</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>          <span class="va">extraConfig</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">             # hide .html ending</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">             if ($request_uri ~ ^/(.*)\.html$) {</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">               return 302 $scheme://$http_host/$1;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">             }</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">             try_files $uri $uri.html $uri/ =404;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">          &#39;&#39;</span><span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="va">extraConfig</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="st">       error_page 404 /404.html;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="st">      &#39;&#39;</span><span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>Nix makes it easy to get Nginx running in just a few lines. Really
the only essential line in <code>virtualhosts."ftzm.org"</code> is
setting <code>root = ${nginxWebRoot}</code> where nginxWebRoot points to
the blog files package defined above. The NixOS configuration is in turn
imported as <code>blog-system</code> in the top level flake:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>nixosConfigurations.blog<span class="op">-</span>system = nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span> <span class="op">(</span><span class="bu">import</span> <span class="ss">./server.nix</span> <span class="op">{</span> <span class="va">nginxWebRoot</span> <span class="op">=</span> packages.files<span class="op">;})];</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>Up until this point everything has been vanilla Nix. The final piece
of the puzzle is to specify <code>deploy.nodes</code>, which will tell
deploy-rs what to deploy. Each node represents a target server to deploy
to. We define a node also named <code>blog-system</code>, within which
we specify the server's hostname, the nix profile to deploy to, and
within that the <code>path</code> of the deployment, which is
essentially the deployment command. The deployment command in this case
is to activate the blog-system nixos configuration.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>deploy.nodes.blog<span class="op">-</span>system = <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">hostname</span> <span class="op">=</span> <span class="st">&quot;ftzm.org&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">profiles</span>.<span class="va">system</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">sshUser</span> <span class="op">=</span> <span class="st">&quot;root&quot;</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">user</span> <span class="op">=</span> <span class="st">&quot;root&quot;</span><span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">path</span> <span class="op">=</span> deploy<span class="op">-</span>rs.lib.x86_64<span class="op">-</span>linux.activate.nixos self.nixosConfigurations.blog<span class="op">-</span>system<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This is highly advised, and will prevent many possible mistakes</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="va">checks</span> <span class="op">=</span> <span class="bu">builtins</span>.mapAttrs <span class="op">(</span><span class="va">system</span><span class="op">:</span> <span class="va">deployLib</span><span class="op">:</span> deployLib.deployChecks self.deploy<span class="op">)</span> deploy<span class="op">-</span>rs.lib<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>All that's necessary to deploy to the defined nodes is to run the
following command:
<code>nix run github:serokell/deploy-rs ./. -- -- --impure</code>.</p>
</section>
    </section>

    <!--<div class="adjacent">
      <a href="/posts/tricks-with-tags-in-hakyll.html" class="next">
	<div class="sample">
	  <h2>Related Posts in Hakyll</h2>
	  <p>The Hakyll framework provides tags out of the box, but no way to leverage them to automatically link to related posts. This post describes how to leverage the existing tags functionality to that end.</p>
	  <date>25 Jan 2018</date>
	</div>
	<div class="arrow">
	  <i class="fas fa-chevron-right"></i>
	</div>
      </a>
    </div>
        <br>
        <br>
	-->

</div>

<footer>
  <p>
    Matthew Fitzsimmons © 2020<br>
    Built with Haskell using&nbsp;<a href="https://github.com/ChrisPenner/slick">Slick</a>&nbsp;•&nbsp;Published with&nbsp;<a href="https://www.nixos.org">Nix</a>
    <p>
</footer>

<script src="/js/main.js"></script>
</body>
</html>
